# Implementation Plan: Finalize Processor

**Branch**: `003-finalize-processor` | **Date**: 2025-12-01 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-finalize-processor/spec.md`

## Summary

Add a shared (language-agnostic) finalize processor that runs after all other processors complete. It generates two outputs: README.md (human-readable build summary with processor table) and bloom.json (machine-readable metadata for tooling/LLM context). The finalize processor reads timing.json from each upstream processor (auto-generated by mkProcessor factory), aggregates statistics, and produces summary files. Unlike other processors, finalize's publish/ contents are placed directly alongside seed.nix (no subfolder).

## Technical Context

**Language/Version**: Nix (flakes-enabled, requires Nix 2.4+)
**Primary Dependencies**: Nix builtins, jq for JSON processing, coreutils for file operations, findutils for directory scanning
**Storage**: Nix store for processor I/O; filesystem for persisted bloom outputs
**Testing**: Nix build validation (successful builds = passing tests), shell script integration tests
**Target Platform**: Any system with Nix installed (Linux, macOS, WSL)
**Project Type**: Single project (extends existing Nix flake from 001-nix-processor-pipeline)
**Performance Goals**: Finalize processor completes in <10 seconds (aggregation only, no network)
**Constraints**: Depends on all upstream processors; must handle variable processor counts per language
**Scale/Scope**: Single finalize processor shared across all languages; outputs 2 files per build

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Gate | Status | Notes |
|------|--------|-------|
| Never over-engineer | PASS | Single processor with 2 outputs; minimal scope |
| Code easy to understand | PASS | Nix is declarative; shell script for generation logic |
| Never create code debt | PASS | Extends clean 001 architecture |
| No backwards compatibility | PASS | New processor, no legacy concerns |
| Extremely modular code | PASS | Finalize is independent; mkProcessor factory handles timing injection |
| Modern tooling only | PASS | Nix flakes, jq for JSON |
| Extensive beginner-friendly comments | REQUIRED | All Nix code must explain what each section does |

## Project Structure

### Documentation (this feature)

```text
specs/003-finalize-processor/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (bloom.json schema, timing.json schema)
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

```text
lib/
├── processors/
│   ├── default.nix          # UPDATE: Add mkProcessor factory with timing injection
│   ├── finalize.nix         # NEW: Shared finalize processor
│   ├── package-download/
│   │   ├── rust.nix         # UPDATE: Use mkProcessor, output to publish/
│   │   └── python.nix       # UPDATE: Use mkProcessor, output to publish/
│   ├── source-download.nix  # UPDATE: Use mkProcessor, output to publish/
│   └── stats.nix            # UPDATE: Use mkProcessor, output to publish/
├── languages/
│   ├── rust.nix             # UPDATE: Add finalize to processor chain
│   └── python.nix           # UPDATE: Add finalize to processor chain
└── utils/
    ├── persist.nix          # UPDATE: Handle finalize special case (no subfolder)
    ├── timing.nix           # NEW: Timing utilities for mkProcessor
    └── format.nix           # NEW: Duration formatting (ms → "Xm Y.ZZs")

tests/
├── integration/
│   ├── test-rust-seed.sh    # UPDATE: Verify README.md and bloom.json
│   └── test-python-seed.sh  # UPDATE: Verify README.md and bloom.json
└── unit/
    ├── test-timing.sh       # NEW: Timing injection tests
    └── test-format.sh       # NEW: Duration formatting tests
```

**Structure Decision**: Extends existing 001 structure. Finalize processor is a single shared file (not per-language). mkProcessor factory is added to lib/processors/default.nix to centralize timing injection. All existing processors updated to use mkProcessor and output to publish/ subfolder.

## Complexity Tracking

No constitution violations requiring justification. The design follows all gates:
- Single new processor file
- mkProcessor factory centralizes timing logic (DRY)
- publish/ subfolder pattern is consistent across all processors

## Post-Design Constitution Re-Check

*Re-evaluated after Phase 1 design artifacts created.*

| Gate | Status | Post-Design Notes |
|------|--------|-------------------|
| Never over-engineer | PASS | Design stays minimal: 1 processor, 2 outputs, 2 JSON schemas |
| Code easy to understand | PASS | Data model uses clear entity definitions; schemas are self-documenting |
| Never create code debt | PASS | Clean extension of 001 architecture; mkProcessor factory centralizes timing |
| No backwards compatibility | PASS | New processor, no legacy concerns |
| Extremely modular code | PASS | Finalize is independent file; publish/ pattern is consistent across all processors |
| Modern tooling only | PASS | Uses Nix flakes, JSON Schema for contracts, jq for JSON manipulation |
| Extensive beginner-friendly comments | REQUIRED | Quickstart explains concepts; code must follow same pattern |

**Conclusion**: Design phase complete. All constitution gates pass. Ready for `/speckit.tasks`.

## Generated Artifacts

| Artifact | Path | Purpose |
|----------|------|---------|
| Research | [research.md](./research.md) | Nix patterns for timing, jq aggregation, markdown generation |
| Data Model | [data-model.md](./data-model.md) | Entity definitions for timing.json, bloom.json, README.md |
| Timing Schema | [contracts/timing.schema.json](./contracts/timing.schema.json) | Per-processor timing.json format |
| Bloom Schema | [contracts/bloom.schema.json](./contracts/bloom.schema.json) | bloom.json output format |
| Quickstart | [quickstart.md](./quickstart.md) | Guide for understanding finalize outputs |
