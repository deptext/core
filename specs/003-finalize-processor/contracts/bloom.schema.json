{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://deptext.dev/schemas/bloom.schema.json",
  "title": "Bloom Metadata",
  "description": "Machine-readable build metadata generated by the finalize processor. Contains package info, build timing, and per-processor statistics. Placed directly alongside seed.nix after build.",
  "type": "object",
  "required": ["pname", "version", "language", "hash", "github", "lastBuild", "buildDuration", "processors"],
  "additionalProperties": false,
  "properties": {
    "pname": {
      "type": "string",
      "minLength": 1,
      "description": "Package name from the registry (e.g., 'serde', 'requests')"
    },
    "version": {
      "type": "string",
      "minLength": 1,
      "description": "Package version (e.g., '1.0.228', '2.31.0')"
    },
    "language": {
      "type": "string",
      "enum": ["rust", "python"],
      "description": "Programming language of the package"
    },
    "hash": {
      "type": "string",
      "pattern": "^sha256:[a-z0-9]+$",
      "description": "Package content hash in Nix SRI format (from package-download metadata)"
    },
    "github": {
      "type": "object",
      "required": ["owner", "repo", "rev", "hash"],
      "additionalProperties": false,
      "description": "GitHub repository information",
      "properties": {
        "owner": {
          "type": "string",
          "minLength": 1,
          "description": "GitHub organization or username"
        },
        "repo": {
          "type": "string",
          "minLength": 1,
          "description": "Repository name"
        },
        "rev": {
          "type": "string",
          "minLength": 1,
          "description": "Git revision (tag like 'v1.0.228' or commit SHA)"
        },
        "hash": {
          "type": "string",
          "pattern": "^sha256:[a-z0-9]+$",
          "description": "Source archive hash in Nix SRI format"
        }
      }
    },
    "lastBuild": {
      "type": "string",
      "format": "date-time",
      "pattern": ".*Z$",
      "description": "ISO 8601 timestamp (UTC) of when the build completed"
    },
    "buildDuration": {
      "type": "integer",
      "minimum": 0,
      "description": "Total build duration in milliseconds (sum of all processor durations)"
    },
    "processors": {
      "type": "object",
      "minProperties": 1,
      "description": "Per-processor status and metrics. Keys are processor names.",
      "additionalProperties": {
        "type": "object",
        "required": ["active", "published"],
        "properties": {
          "active": {
            "type": "boolean",
            "description": "Whether the processor was executed (false if disabled in config)"
          },
          "published": {
            "type": "boolean",
            "description": "Whether the processor's publish/ folder was persisted to disk"
          },
          "buildDuration": {
            "type": "integer",
            "minimum": 0,
            "description": "Processor build duration in milliseconds. Required if active=true, omitted otherwise."
          },
          "fileCount": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of files in publish/ folder. Required if published=true, omitted otherwise."
          },
          "fileSize": {
            "type": "integer",
            "minimum": 0,
            "description": "Total size of publish/ folder in bytes. Required if published=true, omitted otherwise."
          },
          "hash": {
            "type": "string",
            "pattern": "^sha256:[a-z0-9]+$",
            "description": "SHA256 hash of publish/ folder contents. Required if published=true, omitted otherwise."
          }
        },
        "if": {
          "properties": { "active": { "const": true } }
        },
        "then": {
          "required": ["active", "published", "buildDuration"]
        },
        "allOf": [
          {
            "if": {
              "properties": { "published": { "const": true } }
            },
            "then": {
              "required": ["active", "published", "fileCount", "fileSize", "hash"]
            }
          }
        ]
      }
    }
  },
  "examples": [
    {
      "pname": "serde",
      "version": "1.0.228",
      "language": "rust",
      "hash": "sha256:04xwh16jm7szizkkhj637jv23i5x8jnzcfrw6bfsrssqkjykaxcm",
      "github": {
        "owner": "serde-rs",
        "repo": "serde",
        "rev": "v1.0.228",
        "hash": "sha256:0qaz2mclr5cv3s5riag6aj3n3avirirnbi7sxpq4nw1vzrq09j6l"
      },
      "lastBuild": "2025-11-28T12:00:00Z",
      "buildDuration": 342150,
      "processors": {
        "package-download": {
          "active": true,
          "published": false,
          "buildDuration": 251755
        },
        "source-download": {
          "active": true,
          "published": false,
          "buildDuration": 45230
        },
        "stats": {
          "active": true,
          "published": true,
          "buildDuration": 12045,
          "fileCount": 1,
          "fileSize": 48320,
          "hash": "sha256:abc123def456"
        }
      }
    }
  ]
}
