# Data Model: Finalize Processor

**Date**: 2025-12-01
**Branch**: `003-finalize-processor`

## Overview

This document defines the data structures for the finalize processor, including timing.json (per-processor), bloom.json (aggregated output), and README.md (generated markdown).

## Core Entities

### 1. Timing Data (timing.json)

Auto-generated by mkProcessor for each processor. Lives at root of processor output (NOT in publish/).

```json
{
  "startTime": 1701432000000,
  "endTime": 1701432012345,
  "buildDuration": 12345
}
```

| Field | Type | Description |
|-------|------|-------------|
| startTime | integer | Unix epoch milliseconds when build started |
| endTime | integer | Unix epoch milliseconds when build completed |
| buildDuration | integer | Duration in milliseconds (endTime - startTime) |

### 2. Bloom Metadata (bloom.json)

Generated by finalize processor. Lives in publish/ folder → copied to seed directory root.

```json
{
  "pname": "serde",
  "version": "1.0.228",
  "language": "rust",
  "hash": "sha256:04xwh16jm7szizkkhj637jv23i5x8jnzcfrw6bfsrssqkjykaxcm",
  "github": {
    "owner": "serde-rs",
    "repo": "serde",
    "rev": "v1.0.228",
    "hash": "sha256:0qaz2mclr5cv3s5riag6aj3n3avirirnbi7sxpq4nw1vzrq09j6l"
  },
  "lastBuild": "2025-11-28T12:00:00Z",
  "buildDuration": 342150,
  "processors": {
    "package-download": {
      "active": true,
      "published": false,
      "buildDuration": 251755
    },
    "source-download": {
      "active": true,
      "published": false,
      "buildDuration": 45230
    },
    "stats": {
      "active": true,
      "published": true,
      "buildDuration": 12045,
      "fileCount": 1,
      "fileSize": 48320,
      "hash": "sha256:abc123..."
    }
  }
}
```

#### Root Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| pname | string | Yes | Package name (from seed config) |
| version | string | Yes | Package version (from seed config) |
| language | string | Yes | Programming language ("rust", "python") |
| hash | string | Yes | Package content hash (from package-download metadata) |
| github | object | Yes | GitHub repository information |
| lastBuild | string | Yes | ISO 8601 timestamp (UTC) of build completion |
| buildDuration | integer | Yes | Total build duration in milliseconds |
| processors | object | Yes | Per-processor status and metrics |

#### github Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| owner | string | Yes | GitHub organization/user |
| repo | string | Yes | Repository name |
| rev | string | Yes | Git revision (tag or commit) |
| hash | string | Yes | Source archive hash |

#### processors.[name] Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| active | boolean | Yes | Whether processor was executed |
| published | boolean | Yes | Whether output was persisted |
| buildDuration | integer | If active | Duration in milliseconds |
| fileCount | integer | If published | Number of files in publish/ |
| fileSize | integer | If published | Total size in bytes |
| hash | string | If published | SHA256 of publish/ contents |

### 3. README Structure (README.md)

Generated by finalize processor. Lives in publish/ folder → copied to seed directory root.

```markdown
# {pname} v{version}

**Language**: {Language}
**Last Build**: {ISO 8601 timestamp}
**Build Duration**: {human-readable duration}

## Processors

| Processor | Active | Published | Duration | Files | Size |
|-----------|--------|-----------|----------|-------|------|
| {name} | ✓/✗ | [view output](./{name}/) or ✓ or - | {duration} | {count} | {size} |
...
```

#### Column Definitions

| Column | Active=true, Published=true | Active=true, Published=false | Active=false |
|--------|----------------------------|------------------------------|--------------|
| Processor | Processor name | Processor name | Processor name |
| Active | ✓ | ✓ | ✗ |
| Published | `[view output](./{name}/)` | - | - |
| Duration | Xm Y.ZZs | Xm Y.ZZs | - |
| Files | {count} | - | - |
| Size | X.XX MB/KB/B | - | - |

### 4. Processor Output Structure

Each processor's Nix store output directory:

```text
/nix/store/xxx-deptext-{processor}-{pname}-{version}/
├── timing.json              # Auto-generated by mkProcessor (NOT in publish/)
└── publish/                 # User-facing content (persisted if persist=true)
    └── {processor-specific files}
```

#### Finalize Processor Output

```text
/nix/store/xxx-deptext-finalize-{pname}-{version}/
├── timing.json              # Finalize's own timing
└── publish/
    ├── README.md            # Human-readable summary
    └── bloom.json           # Machine-readable metadata
```

### 5. Persisted Directory Structure

After build completes, alongside seed.nix:

```text
nursery/rust/s/se/serde/1.0.228/
├── seed.nix                 # User's seed file
├── README.md                # From finalize/publish/ (root level)
├── bloom.json               # From finalize/publish/ (root level)
├── stats/                   # From stats/publish/ (if persist=true)
│   └── stats.json
├── package-download/        # From package-download/publish/ (if persist=true)
│   └── ...
└── source-download/         # From source-download/publish/ (if persist=true)
    └── ...
```

## State Transitions

### Processor States

```text
┌──────────────┐
│   Pending    │  (deps not ready)
└──────┬───────┘
       │ deps complete
       ▼
┌──────────────┐
│   Building   │  ← timing.json startTime captured
└──────┬───────┘
       │ buildPhase complete
       ▼
┌──────────────┐
│  Completed   │  ← timing.json endTime captured
└──────────────┘
```

### Finalize Aggregation Flow

```text
┌─────────────────────────────────────────────────────────────────┐
│ Finalize receives all upstream processor outputs as inputs      │
└─────────────────────────────────────────────────────────────────┘
                              │
         ┌────────────────────┼────────────────────┐
         ▼                    ▼                    ▼
   ┌───────────┐        ┌───────────┐        ┌───────────┐
   │ Read      │        │ Read      │        │ Read      │
   │ timing.   │        │ timing.   │        │ timing.   │
   │ json      │        │ json      │        │ json      │
   └─────┬─────┘        └─────┬─────┘        └─────┬─────┘
         │                    │                    │
         ▼                    ▼                    ▼
   ┌───────────┐        ┌───────────┐        ┌───────────┐
   │ Scan      │        │ Scan      │        │ Scan      │
   │ publish/  │        │ publish/  │        │ publish/  │
   │ (if       │        │ (if       │        │ (if       │
   │ persist)  │        │ persist)  │        │ persist)  │
   └─────┬─────┘        └─────┬─────┘        └─────┬─────┘
         │                    │                    │
         └────────────────────┼────────────────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │ Aggregate into    │
                    │ bloom.json +      │
                    │ README.md         │
                    └───────────────────┘
```

## Validation Rules

### timing.json

| Field | Rule | Error |
|-------|------|-------|
| startTime | Positive integer | "Invalid start time" |
| endTime | Positive integer, >= startTime | "Invalid end time" |
| buildDuration | Equals (endTime - startTime) | "Duration mismatch" |

### bloom.json

| Field | Rule | Error |
|-------|------|-------|
| pname | Non-empty string | "Package name required" |
| version | Non-empty string | "Version required" |
| language | One of: "rust", "python" | "Invalid language" |
| lastBuild | Valid ISO 8601 with Z suffix | "Invalid timestamp format" |
| buildDuration | Positive integer | "Invalid duration" |
| processors | Non-empty object | "At least one processor required" |

### Processor Entry

| Field | Rule | Error |
|-------|------|-------|
| active | Boolean | "Active must be boolean" |
| published | Boolean | "Published must be boolean" |
| buildDuration | Required if active=true | "Duration required for active processor" |
| fileCount | Required if published=true; non-negative | "File count required for published processor" |
| fileSize | Required if published=true; non-negative | "File size required for published processor" |
| hash | Required if published=true; valid SHA256 | "Hash required for published processor" |

## Identity and Uniqueness

- **Processor identity**: `{processor-name}` within a build (unique per language)
- **Bloom identity**: `{language}/{pname}/{version}` (matches seed identity from 001)
- **File identity**: SHA256 hash of publish/ directory contents
