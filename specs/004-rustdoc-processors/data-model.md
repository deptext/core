# Data Model: Rustdoc Processors

**Date**: 2025-12-01
**Feature**: 004-rustdoc-processors

## Overview

This document describes the data entities, their attributes, and relationships for the rustdoc processor feature.

---

## Entities

### 1. RustdocJsonProcessor

**Purpose**: Generates JSON documentation from Rust source code.

**Attributes:**
| Attribute | Type | Description |
|-----------|------|-------------|
| name | string | Always "rustdoc-json" |
| pname | string | Package name (e.g., "serde") |
| version | string | Package version (e.g., "1.0.215") |
| enabled | boolean | Whether processor runs (default: true) |
| persist | boolean | Whether output is persisted (default: false) |
| sourceDownload | derivation | Input: source code from source-download processor |

**Output Structure:**
```text
$out/
├── timing.json          # Auto-generated by mkProcessor
└── publish/
    └── {pname}.json     # Rustdoc JSON output (single file)
```

**Relationships:**
- **Depends on**: source-download processor (requires source code)
- **Depended on by**: rustdoc-md processor

---

### 2. RustdocMdProcessor

**Purpose**: Converts rustdoc JSON to human-readable Markdown.

**Attributes:**
| Attribute | Type | Description |
|-----------|------|-------------|
| name | string | Always "rustdoc-md" |
| pname | string | Package name (e.g., "serde") |
| version | string | Package version (e.g., "1.0.215") |
| enabled | boolean | Whether processor runs (default: true) |
| persist | boolean | Whether output is persisted (default: true) |
| rustdocJson | derivation | Input: JSON from rustdoc-json processor |

**Output Structure:**
```text
$out/
├── timing.json          # Auto-generated by mkProcessor
└── publish/
    └── docs.md          # Markdown documentation (single file)
```

**Relationships:**
- **Depends on**: rustdoc-json processor (requires JSON input)
- **Depended on by**: finalize processor (for summary)

---

### 3. ProcessorConfig (Extended)

**Purpose**: User-configurable settings in seed.nix.

**New Attributes (added to existing config):**
| Attribute | Type | Default | Description |
|-----------|------|---------|-------------|
| rustdoc-json.enabled | boolean | true | Enable/disable JSON generation |
| rustdoc-json.persist | boolean | false | Persist JSON output |
| rustdoc-md.enabled | boolean | true | Enable/disable markdown generation |
| rustdoc-md.persist | boolean | true | Persist markdown output |

**Validation Rules:**
- If `rustdoc-json.enabled = false`, then `rustdoc-md` is implicitly disabled (dependency chain)
- If `rustdoc-md.enabled = false` but `rustdoc-json.enabled = true`, JSON is still generated but markdown is not

---

## Data Flow

```text
source-download
      │
      ▼
┌─────────────────┐
│  rustdoc-json   │ ←── Runs cargo +nightly rustdoc
│  (persist=false)│
└────────┬────────┘
         │ JSON file
         ▼
┌─────────────────┐
│   rustdoc-md    │ ←── Runs rustdoc-md tool
│  (persist=true) │
└────────┬────────┘
         │
         ▼
     finalize
```

**Parallel Execution:**
- `stats` processor runs in parallel with the rustdoc chain
- Both consume `source-download` output independently
- `finalize` waits for both chains to complete

---

## State Transitions

### Processor States

| State | Description |
|-------|-------------|
| Disabled | `enabled = false` - processor doesn't run, outputs skip marker |
| Building | Processor is actively generating output |
| Completed | Output available in `$out/publish/` |
| Failed | Error during generation, build fails |

### Dependency State Rules

```text
rustdoc-json.enabled=false  →  rustdoc-md state = Disabled (forced)
rustdoc-json.enabled=true   →  rustdoc-md state = depends on its own enabled flag
```

---

## Output File Formats

### rustdoc-json Output (JSON)

```json
{
  "root": "0:0:1234",
  "crate_version": "1.0.215",
  "includes_private": false,
  "index": {
    "0:0:1234": {
      "id": "0:0:1234",
      "crate_id": 0,
      "name": "serde",
      "span": {...},
      "visibility": "public",
      "docs": "Serde is a framework for serializing...",
      "attrs": [...],
      "inner": {"kind": "module", "inner": {...}}
    }
  },
  "paths": {...},
  "external_crates": {...},
  "format_version": 42
}
```

### rustdoc-md Output (Markdown)

```markdown
# serde v1.0.215

Serde is a framework for serializing and deserializing Rust data structures.

## Modules

### `serde::de`

Deserialization support...

## Structs

### `Deserializer`

A structure that deserializes...

## Traits

### `Serialize`

A trait for serializing data...
```

---

## Integration Points

### finalize.nix Updates Required

The finalize processor must be updated to:
1. Include `rustdoc-json` and `rustdoc-md` in the processor iteration loop
2. Read timing.json from both processors
3. Include both in README.md processor table
4. Include both in bloom.json processors object

### rust.nix Updates Required

The Rust language helper must be updated to:
1. Import rustdoc-json and rustdoc-md processor modules
2. Add both to processorConfig defaults
3. Create derivations in the pipeline
4. Wire dependency chain (rustdoc-md depends on rustdoc-json)
5. Pass both to finalize and persist wrapper
