#!/usr/bin/env bash
# DepText CLI - Bloom seeds with minimal boilerplate
#
# USAGE:
#   deptext bloom <seed.nix> [nix-bloom-options...]
#
# EXAMPLES:
#   deptext bloom ./seed.nix
#   deptext bloom ./seed.nix --print-out-paths
#   deptext bloom ./seed.nix -o ./result

set -euo pipefail

# Find the deptext root (where this script lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEPTEXT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

usage() {
  cat <<EOF
DepText - Package processing pipeline for LLM context generation

USAGE:
  deptext <command> [options]

COMMANDS:
  bloom <seed.nix>   Bloom a seed file
  help               Show this help message

EXAMPLES:
  deptext bloom ./seed.nix
  deptext bloom ./seed.nix --print-out-paths
  deptext bloom examples/rust/serde/seed.nix -o ./result

EOF
}

cmd_bloom() {
  if [ $# -lt 1 ]; then
    echo "Error: Missing seed path" >&2
    echo "Usage: deptext bloom <seed.nix> [nix-bloom-options...]" >&2
    exit 1
  fi

  local seed_path="$1"
  shift

  # Resolve to absolute path
  if [[ "$seed_path" != /* ]]; then
    seed_path="$(pwd)/$seed_path"
  fi
  seed_path="$(cd "$(dirname "$seed_path")" && pwd)/$(basename "$seed_path")"

  if [ ! -f "$seed_path" ]; then
    echo "Error: Seed file not found: $seed_path" >&2
    exit 1
  fi

  # Bloom the seed using eval-seed.nix wrapper
  nix build \
    --impure \
    --file "$DEPTEXT_ROOT/lib/eval-seed.nix" \
    --argstr seedPath "$seed_path" \
    "$@"
}

# Main command dispatch
case "${1:-help}" in
  bloom)
    shift
    cmd_bloom "$@"
    ;;
  help|--help|-h)
    usage
    ;;
  *)
    echo "Error: Unknown command '$1'" >&2
    echo "Run 'deptext help' for usage" >&2
    exit 1
    ;;
esac
