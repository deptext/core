#!/usr/bin/env bash
# bloom - Bloom seeds with minimal boilerplate
#
# USAGE:
#   bloom <seed.nix> [nix-build-options...]
#
# EXAMPLES:
#   bloom ./seed.nix
#   bloom ./seed.nix --print-out-paths
#   bloom ./seed.nix -o ./result

set -euo pipefail

# Find the project root (where this script lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors and styling
BOLD='\033[1m'
DIM='\033[2m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
RESET='\033[0m'

# Logging functions
log_seed()  { echo -e "${CYAN}${BOLD}[seed]${RESET} $1"; }
log_grow()  { echo -e "${YELLOW}${BOLD}[grow]${RESET} $1"; }
log_bloom() { echo -e "${GREEN}${BOLD}[bloom]${RESET} $1"; }

usage() {
  cat <<EOF
bloom - Bloom seeds for LLM context generation

USAGE:
  bloom <seed.nix> [nix-build-options...]

EXAMPLES:
  bloom ./seed.nix
  bloom ./seed.nix --print-out-paths
  bloom examples/rust/serde/seed.nix -o ./result

EOF
}

if [ $# -lt 1 ] || [ "${1:-}" = "--help" ] || [ "${1:-}" = "-h" ]; then
  usage
  [ $# -lt 1 ] && exit 1
  exit 0
fi

seed_path="$1"
shift

# Resolve to absolute path
if [[ "$seed_path" != /* ]]; then
  seed_path="$(pwd)/$seed_path"
fi
seed_path="$(cd "$(dirname "$seed_path")" && pwd)/$(basename "$seed_path")"

if [ ! -f "$seed_path" ]; then
  echo -e "${BOLD}Error:${RESET} Seed file not found: $seed_path" >&2
  exit 1
fi

seed_name="$(basename "$seed_path" .nix)"
log_seed "found ${BOLD}${seed_name}${RESET}"
log_grow "germinating..."

# Bloom the seed using eval-seed.nix wrapper
if nix build \
  --impure \
  --file "$PROJECT_ROOT/lib/eval-seed.nix" \
  --argstr seedPath "$seed_path" \
  "$@"; then
  log_bloom "${BOLD}${seed_name}${RESET} has bloomed"
else
  echo -e "${BOLD}Error:${RESET} Failed to bloom ${seed_name}" >&2
  exit 1
fi
